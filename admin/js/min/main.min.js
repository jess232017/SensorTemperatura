function imageExists(e){var t=new XMLHttpRequest;return t.open("HEAD",e,!1),t.send(),404!=t.status}function enviarNotificacion(e,t,a="",r=""){let o=new Headers;o.append("Authorization","Basic ODU0NmI1YTMtZjAyNy00ZDRkLTgyODAtNTc3MDAzMmU0ZTQ2"),o.append("Content-Type","application/json"),o.append("Cookie","__cfduid=d27872b10d36f1b3e813c8c6f3cfc19d11619630966");e=JSON.stringify({app_id:"478939bb-8e38-49fc-84fc-7115a4e05b8a",url:a,chrome_web_image:r,included_segments:["Subscribed Users"],data:{foo:"bar"},contents:{en:t},headings:{en:e}}),e={method:"POST",headers:o,body:e,redirect:"follow"};fetch("https://onesignal.com/api/v1/notifications",e).then(e=>e.text()).then(e=>console.log(e)).catch(e=>console.log("error",e))}function enviarImagen(e,t){let a=new FormData;a.append("file",e.files[0]),a.append("upload_preset","ml_default"),a.append("public_id",t);t={method:"POST",body:a,redirect:"follow"};fetch("https://api.cloudinary.com/v1_1/js-media/upload",t).then(e=>e.text()).then(e=>console.log(e)).catch(e=>console.log("error",e))}function obtenerImagen(e,t){e=`https://res.cloudinary.com/js-media/image/upload/c_thumb,g_face,h_250,w_250/v1620739560/STC-UNI/Estudiantes/${e}.jpg`;imageExists(e)?$(t).attr("src",e):$(t).attr("src","https://img.icons8.com/office/16/000000/no-image.png")}const iconoEditar='<svg class="bi bi-pencil-square" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>',iconoBorrar='<svg class="bi bi-trash" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>',firebaseConfig={apiKey:"AIzaSyCi6xuTAzN3SdQV7WOHWYOgK1aabuOZHcA",authDomain:"sensor-de-temperatura-a0371.firebaseapp.com",databaseURL:"https://sensor-de-temperatura-a0371-default-rtdb.firebaseio.com",projectId:"sensor-de-temperatura-a0371",storageBucket:"gs://sensor-de-temperatura-a0371.appspot.com/",messagingSenderId:"251434379203",appId:"1:251434379203:web:1c923b67801ba4c7e3bf76",measurementId:"G-S380YW4E3B"};var Sensor_IdCode="null",isConnected=!1;firebase.initializeApp(firebaseConfig);const db=firebase.database(),dbEstudiantes=db.ref().child("estudiantes"),dbAsistencias=db.ref().child("asistencias"),dbSensor1=db.ref().child("sensores/sensor-01"),txtDegree=document.querySelector(".visual-number");var myChart,connectedRef=firebase.database().ref(".info/connected").on("value",e=>{e.val()});function getStudent(e,t){dbEstudiantes.orderByChild("codigo").equalTo(e).once("value",e=>{t(e)})}function getAttendees(e,t){dbAsistencias.orderByChild("codigo").equalTo(e).once("value",e=>{t(e)})}function showTemperatura(){var e;$("#main-chart").length&&(e=document.querySelector("#main-chart").getContext("2d"),myChart=new Chart(e,{type:"line",data:{labels:[],datasets:[{data:[],label:"Temperatura",fill:!0,backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:1,borderColor:"blue"}]}}))}function setGaugeTemperature(){var e;$("#gauge-temperature").length&&(e=document.querySelector("#gauge-temperature"),gauge=new Gauge(e).setOptions({angle:-.09,animationSpeed:63,colorStart:"#6FADCF",colorStop:"#8FC0DA",currval:1500,fontSize:42,generateGradient:!0,lineWidth:.43,pointer:{length:.31,color:"#000000",strokeWidth:.115},radiusScale:1,renderTicks:{divColor:"#333333",divLength:.45,divWidth:1.1,divisions:3,subColor:"#666666",subDivisions:3,subLength:.5,subWidth:.6},staticLabels:{font:"10px sans-serif",labels:[-40,-20,0,20,40],color:"#000000",fractionDigits:0},strokeColor:"#E0E0E0",staticZones:[{strokeStyle:"#6495ed",min:-50,max:-20},{strokeStyle:"#96acd6",min:-21,max:20},{strokeStyle:"#FFDD00",min:19,max:33},{strokeStyle:"#30B32D",min:32,max:37},{strokeStyle:"#F03E3E",min:37,max:50}]}),gauge.maxValue=50,gauge.setMinValue(-50),gauge.animationSpeed=32,gauge.set(50))}firebase.firestore().enablePersistence(),dbSensor1.on("value",e=>{let t=e.val();"undefined"!=typeof gauge&&gauge.set(t.temperatura),$(".visual-number").text(t.temperatura),document.querySelector("#txtTemperatura").value=t.temperatura,"null"!=Sensor_IdCode&&Sensor_IdCode!==t.codigo&&openNewAttend(t.codigo.split("?date=")[0]),Sensor_IdCode=t.codigo}),dbEstudiantes.on("value",e=>{drawStudentTable(e.val())}),dbAsistencias.on("value",e=>{drawAttendTable(e.val())}),$("form#frm-attend").submit(e=>{e.preventDefault();let t=$("#idAsistencia").val();""==t&&(t=dbAsistencias.push().key),data={codigo:idCode,fecha:fecha,hora:hora,temperatura:temperatura,descripcion:descripcion},actualizacionData={},actualizacionData[`/${t}`]=data,dbAsistencias.update(actualizacionData).then(()=>{37<parseInt(temperatura)&&enviarNotificacion(titleAlert,descripcionAlert,`https://stc-uni.netlify.app/admin/student-info.html?id=${idCode}`,`https://res.cloudinary.com/js-media/image/upload/w_1000,ar_2:1,c_fill,g_auto/STC-UNI/Estudiantes/${idCode}.jpg`)}).catch(e=>{alert(e)}),t="",resetModal()}),$("form#reg-Student").submit(e=>{e.preventDefault();e=dbEstudiantes.push().key;data={apellidos:$("#txtApellidos").val(),carrera:$("#txtCarrera").val(),codigo:$("#txtCarnet").val(),correo:$("#txtCorreo").val(),direccion:$("#txtDireccion").val(),nombres:$("#txtNombres").val(),sexo:$("#txtSexo").val(),telefono:$("#txtTelefono").val()},actualizacionData={},actualizacionData[`/${e}`]=data,dbEstudiantes.update(actualizacionData).then(e=>{console.log(e)}).catch(e=>{console.log(e)}),enviarImagen(document.querySelector("#addImage"),data.codigo),document.querySelector("#closeModal").click()}),showTemperatura(),setGaugeTemperature();var stepper=new Stepper(document.querySelector("#stpIngresar")),path=window.location.pathname,page=path.split("/").pop();""!=page&&"student-info.html"!=page?document.querySelector(`a[href='${page}']`).style.backgroundColor="#323d4c":document.querySelector("a[href='index.html']").style.backgroundColor="#323d4c";var idCode,temperatura,hora,fecha,descripcion,titleAlert,descripcionAlert,Pushed=!1,btnMas=document.querySelector("#btnMas");function nextStep(){let e=new Date;idCode=$("#txtCodigo").val(),temperatura=$("#txtTemperatura").val(),descripcion=Pushed?(hora=$("#txtHora").val(),fecha=$("#txtFecha").val(),$("#txtDescripcion").val()):(hora=e.toLocaleTimeString("en-US"),fecha=e.toLocaleDateString("en-US"),""),getStudent(idCode,validarForm)}function validarForm(t){if(t.exists()){let e=!0;e=validarCampo("#txtCodigo",e),e=validarCampo("#txtTemperatura",e),Pushed&&(e=validarCampo("#txtFecha",e),e=validarCampo("#txtHora",e)),e&&(t=(t=t.val())[Object.keys(t)[0]],obtenerImagen(idCode,"#cardImagen"),$("#regHora").text(hora),$("#regFecha").text(fecha),$("#txtIded").text(idCode),$("#txtIded").attr("href",`student-info.html?id=${idCode}`),$("#regTemp").text(temperatura+" ºC "),$("#txtCareer").text(t.carrera),$("#txtNombre").text(`${t.nombres} ${t.apellidos}`),37<parseInt(temperatura)?($("#regTemp").addClass("text-danger"),titleAlert=`Alerta: ${t.nombres} ${t.apellidos}`,descripcionAlert=`Estudiante de ${t.carrera} presenta fiebre de ${temperatura}ºC a las ${hora}`):$("#regTemp").removeClass("text-danger"),stepper.next())}else document.querySelector("#txtCodigo").classList.add("is-invalid"),stepper.reset()}function validarCampo(e,t){let a=document.querySelector(e);return""===a.value?(a.classList.add("is-invalid"),!1):(a.classList.remove("is-invalid"),a.classList.add("is-valid"),!!t)}function resetModal(){stepper.reset(),document.querySelector("#txtCodigo").classList.remove("is-valid"),document.querySelector("#txtTemperatura").classList.remove("is-valid"),document.querySelector("#txtFecha").classList.remove("is-valid"),document.querySelector("#txtHora").classList.remove("is-valid"),document.querySelector("form#frm-attend").reset()}function ajustPerson(t){if(t.exists()){t=t.val();var a=Object.keys(t)[0];let e=t[a];e.fbcode=a,setPersonCard([e.fbcode,e.codigo,e.nombres,e.apellidos,e.carrera,e.sexo,e.direccion])}else alert("No se encontro informacion del estudiante")}function ajustAlert(e){if(e.exists())for(var t in document.querySelector("#listAlertas").innerHTML="",e=e.val()){t=e[t];38<=t.temperatura&&setAlertCard(t)}else document.querySelector("#listAlertas").innerHTML=`
            <li class="d-flex justify-content-center">
                <div class="align-items-center text-white bg-primary border-0">
                    <div class="d-flex">
                        <div class="toast-body">
                            No hay ninguna alerta
                        </div>
                    </div>
                </div>
            </li>
        `}function setPersonCard(e){obtenerImagen(e[1],"#imgPerson"),$("#div-list").addClass("col-xl-8"),$("#div-person").removeClass("hide"),tableUser.columns.adjust().draw(),tableAttend.columns.adjust().draw(),$("#tdCarnet").text(e[1]),$("#txt-Nombre").text(e[2]),$("#tdApellido").text(e[3]),$("#tdCarrera").text(e[4]),$("#tdDireccion").text(e[6]),$("#link-person").attr("href",`student-info.html?id=${e[1]}`),document.querySelector("#txtCodigo").value=e[1]}function setAlertCard(e){let t=document.querySelector("ul#listAlertas"),a=document.createElement("li");a.classList.add("timeline-item"),a.innerHTML=`
            <strong>Temperatura: ${e.temperatura}º</strong>
            <span class="float-right text-muted text-sm">${e.fecha}</span>
            <p>La temperatura que se registro a las <span id="regHora" class="font-weight-bold">${e.hora}</span> 
            del estudiante es alta</p>
            
    `,t.appendChild(a)}btnMas.addEventListener("click",function(){btnMas.innerText=Pushed?"Ver más":"Ver menos",Pushed=!Pushed}),document.getElementById("regAsistencia").addEventListener("hidden.bs.modal",resetModal);let params=new URLSearchParams(location.search);var idPerson=params.get("id");function ajustAlertTable(e){if(e.exists())for(var t in e=e.val()){t=e[t];38<=t.temperatura&&setAlertTable(t)}else document.querySelector("#listAlertas").innerHTML=`
            <li class="d-flex justify-content-center">
                <div class="align-items-center text-white bg-primary border-0">
                    <div class="d-flex">
                        <div class="toast-body">
                            No hay ninguna alerta
                        </div>
                    </div>
                </div>
            </li>
        `}function setAlertTable(e){let t=document.querySelector("#listAlertas"),a=document.createElement("tr");a.innerHTML=`
        <td class="text-center">
            <img src="https://img.icons8.com/windows/24/000000/box-important--v4.png"/>
        </td>
        <td>
            La temperatura registrada es de ${e.temperatura}º, la cual, supera el rango normal establecido.
        </td>
        <td>
            ${e.fecha} ${e.hora}
        </td>
    `,t.appendChild(a),console.log(a)}null!=idPerson&&(getStudent(idPerson,ajustPerson),getAttendees(idPerson,ajustAlertTable),$("#tabAlertas").click());var shadow=document.createElement("div");function toogleMenu(){let e=document.querySelector("aside#sidebar");document.querySelector("body").appendChild(shadow),e.classList.add("c-sidebar-show")}function openNewAttend(e){document.body.classList.contains("modal-open")||document.querySelector("#fab").click(),document.querySelector("#txtCodigo").value=e,nextStep()}shadow.className="c-sidebar-backdrop c-fade c-show",shadow.addEventListener("click",()=>{shadow.parentNode.removeChild(shadow),sidebar.classList.remove("c-sidebar-show")});var tableUser=$("#table-user").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:[{targets:[0],visible:!1},{targets:-1,defaultContent:"<div class='wrapper text-center'><div class='btn-group'><button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>"+iconoEditar+"</button><button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>"+iconoBorrar+"</button></div></div>"}]});$("#table-user tbody").on("click","tr",function(){var e=tableUser.row(this).data();setPersonCard(e),getAttendees(e[1],ajustAlert)});var tableAttend=$("#table-attend").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:[{targets:[0],visible:!1},{targets:-1,defaultContent:"<div class='wrapper text-center'><div class='btn-group'><button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>"+iconoEditar+"</button><button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>"+iconoBorrar+"</button></div></div>"}]}),tablehight=$("#table-hight").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:[{targets:[0],visible:!1},{targets:-1,defaultContent:"<div class='wrapper text-center'><div class='btn-group'><button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>"+iconoEditar+"</button><button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>"+iconoBorrar+"</button></div></div>"}]}),tablePerson=$("#table-attend-personal").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:[{targets:[0],visible:!1},{targets:-1,defaultContent:"<div class='wrapper text-center'><div class='btn-group'><button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>"+iconoEditar+"</button><button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>"+iconoBorrar+"</button></div></div>"}]});function drawStudentTable(e){for(var t in tableUser.clear().draw(),e){var a=e[t];dataSet=[t,a.codigo,a.nombres,a.apellidos,a.carrera,a.sexo,a.direccion,a.telefono,a.correo],tableUser.rows.add([dataSet]).draw()}tableUser.columns.adjust().draw()}function drawAttendTable(e){for(var t in tablePerson.clear().draw(),tableAttend.clear().draw(),tablehight.clear().draw(),e){var a=e[t];dataSet=[t,a.codigo,a.fecha,a.hora,a.temperatura],tableAttend.rows.add([dataSet]).draw(),37<a.temperatura&&tablehight.rows.add([dataSet]).draw(),a.codigo===idPerson&&tablePerson.rows.add([dataSet]).draw()}tablePerson.columns.adjust().draw(),tableAttend.columns.adjust().draw(),tablehight.columns.adjust().draw()}$("#table-attend tbody").on("click","tr",function(){var e=tableAttend.row(this).data();getStudent(e[1],ajustPerson),getAttendees(e[1],ajustAlert)});