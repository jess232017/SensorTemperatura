function imageExists(e){var t=new XMLHttpRequest;return t.open("HEAD",e,!1),t.send(),404!=t.status}function enviarNotificacion(e,t,a="",r=""){let o=new Headers;o.append("Authorization","Basic ODU0NmI1YTMtZjAyNy00ZDRkLTgyODAtNTc3MDAzMmU0ZTQ2"),o.append("Content-Type","application/json"),o.append("Cookie","__cfduid=d27872b10d36f1b3e813c8c6f3cfc19d11619630966");e=JSON.stringify({app_id:"478939bb-8e38-49fc-84fc-7115a4e05b8a",url:a,chrome_web_image:r,included_segments:["Subscribed Users"],data:{foo:"bar"},contents:{en:t},headings:{en:e}}),e={method:"POST",headers:o,body:e,redirect:"follow"};fetch("https://onesignal.com/api/v1/notifications",e).then(e=>e.text()).then(e=>console.log(e)).catch(e=>console.log("error",e))}function enviarImagen(e,t){let a=new FormData;a.append("file",e.files[0]),a.append("upload_preset","ml_default"),a.append("public_id",t);t={method:"POST",body:a,redirect:"follow"};fetch("https://api.cloudinary.com/v1_1/js-media/upload",t).then(e=>e.text()).then(e=>console.log(e)).catch(e=>console.log("error",e))}function obtenerImagen(e,t){e=`https://res.cloudinary.com/js-media/image/upload/c_thumb,g_face,h_250,w_250/v1620739560/STC-UNI/Estudiantes/${e}.jpg`;imageExists(e)?$(t).attr("src",e):$(t).attr("src","https://img.icons8.com/office/16/000000/no-image.png")}const firebaseConfig={apiKey:"AIzaSyCi6xuTAzN3SdQV7WOHWYOgK1aabuOZHcA",authDomain:"sensor-de-temperatura-a0371.firebaseapp.com",databaseURL:"https://sensor-de-temperatura-a0371-default-rtdb.firebaseio.com",projectId:"sensor-de-temperatura-a0371",storageBucket:"gs://sensor-de-temperatura-a0371.appspot.com/",messagingSenderId:"251434379203",appId:"1:251434379203:web:1c923b67801ba4c7e3bf76",measurementId:"G-S380YW4E3B"};var Sensor_IdCode="null",isConnected=!1;firebase.initializeApp(firebaseConfig);const db=firebase.database(),dbEstudiantes=db.ref().child("estudiantes"),dbAsistencias=db.ref().child("asistencias"),dbSensor1=db.ref().child("sensores/sensor-01"),txtDegree=document.querySelector(".visual-number");var chartDegree,temperatureChart,charthumidity,humidityChart,connectedRef=firebase.database().ref(".info/connected").on("value",e=>{e.val()});function fromArduino(e){dbSensor1.child("from-serial").set(e,e=>{e&&console.log("Error al escribir: "+e)})}function getStudent(e,t){dbEstudiantes.orderByChild("codigo").equalTo(e).once("value",e=>{t(e)})}function getStudentById(a,r){dbEstudiantes.child(a).once("value",e=>{let t=e.val();t.idFirebase=a,r(t)})}function getAttendees(e,t){dbAsistencias.orderByChild("codigo").equalTo(e).once("value",e=>{t(e)})}function getAttendById(a,r){dbAsistencias.child(a).once("value",e=>{let t=e.val();t.idFirebase=a,r(t)})}if(firebase.firestore().enablePersistence(),dbSensor1.child("codigo").on("value",e=>{let t=e.val();"null"!=Sensor_IdCode&&openNewAttend(t.split("?date=")[0]),Sensor_IdCode=t}),dbSensor1.child("temperatura").on("value",e=>{e=e.val();"undefined"!=typeof gauge&&gauge.set(e),60<Contador&&removeData(myChart),$("#visual-thermostat").text(e),document.querySelector("#txtTemperatura").value=e,addData(temperatureChart,(new Date).toLocaleTimeString(),e)}),dbSensor1.child("humedad").on("value",e=>{var t=e.val();"undefined"!=typeof gaugeHumidity&&gaugeHumidity.set(t),60<Contador&&removeData(humidityChart),$("#visual-humidity").text(e.val()),addData(humidityChart,(new Date).toLocaleTimeString(),t)}),dbSensor1.child("from-serial").on("value",e=>{isServing||writeInConsole(e.val().replace(/\x0D\x0A/g,"<br/>"))}),dbEstudiantes.on("value",e=>{drawStudentTable(e.val())}),dbAsistencias.on("value",e=>{drawAttendTable(e.val())}),$("form#frm-attend").submit(e=>{e.preventDefault();let t=$("#idAsistencia").val();""==t&&(t=dbAsistencias.push().key),data={codigo:idCode,fecha:fecha,hora:hora,temperatura:temperatura,descripcion:descripcion},actualizacionData={},actualizacionData[`/${t}`]=data,dbAsistencias.update(actualizacionData).then(()=>{37<parseInt(temperatura)&&enviarNotificacion(titleAlert,descripcionAlert,`https://stc-uni.netlify.app/admin/student-info.html?id=${idCode}`,`https://res.cloudinary.com/js-media/image/upload/ar_2:1,b_rgb:ffffff,bo_0px_solid_rgb:000,c_pad,h_500,o_90,q_50,w_1000/v1620739560/STC-UNI/Estudiantes/${idCode}.jpg`)}).catch(e=>{alert(e)}),t="",resetModal()}),$("form#reg-Student").submit(e=>{e.preventDefault();let t=$("#idEstudiante").val();""==t&&(t=dbAsistencias.push().key),data={apellidos:$("#txtApellidos").val(),carrera:$("#txtCarrera").val(),codigo:$("#txtCarnet").val(),correo:$("#txtCorreo").val(),direccion:$("#txtDireccion").val(),nombres:$("#txtNombres").val(),sexo:$("#txtSexo").val(),telefono:$("#txtTelefono").val()},actualizacionData={},actualizacionData[`/${t}`]=data,dbEstudiantes.update(actualizacionData).then(e=>{console.log(e)}).catch(e=>{console.log(e)}),t="",enviarImagen(document.querySelector("#addImage"),data.codigo),document.querySelector("#closeModal").click()}),$("#main-chart").length&&(chartDegree=document.querySelector("#main-chart").getContext("2d"),temperatureChart=new Chart(chartDegree,{type:"line",data:{labels:[],datasets:[{data:[],label:"Temperatura",fill:!0,backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:1,borderColor:"blue"}]}})),$("#humidity-chart").length&&(charthumidity=document.querySelector("#humidity-chart").getContext("2d"),humidityChart=new Chart(charthumidity,{type:"line",data:{labels:[],datasets:[{data:[],label:"Humedad",fill:!0,backgroundColor:"rgba(54, 162, 235, 0.2)",borderWidth:1,borderColor:"blue"}]}})),$("#gauge-temperature").length){var aux={angle:-.09,animationSpeed:63,colorStart:"#6FADCF",colorStop:"#8FC0DA",currval:1500,fontSize:42,generateGradient:!0,lineWidth:.43,pointer:{length:.31,color:"#000000",strokeWidth:.115},radiusScale:1,renderTicks:{divColor:"#333333",divLength:.45,divWidth:1.1,divisions:3,subColor:"#666666",subDivisions:3,subLength:.5,subWidth:.6},staticLabels:{font:"10px sans-serif",labels:[-40,-20,0,20,40],color:"#000000",fractionDigits:0},strokeColor:"#E0E0E0",staticZones:[{strokeStyle:"#6495ed",min:-50,max:-20},{strokeStyle:"#96acd6",min:-21,max:20},{strokeStyle:"#FFDD00",min:19,max:33},{strokeStyle:"#30B32D",min:32,max:37},{strokeStyle:"#F03E3E",min:37,max:50}]};let e=document.querySelector("#gauge-temperature");gauge=new Gauge(e).setOptions(aux),gauge.maxValue=50,gauge.setMinValue(-50),gauge.animationSpeed=32,gauge.set(50)}if($("#gauge-humidity").length){var opts={angle:.15,lineWidth:.44,radiusScale:1,pointer:{length:.6,strokeWidth:.035,color:"#000000"},limitMax:!1,limitMin:!1,colorStart:"#6FADCF",colorStop:"#8FC0DA",strokeColor:"#E0E0E0",generateGradient:!0,highDpiSupport:!0};let e=document.querySelector("#gauge-humidity");gaugeHumidity=new Gauge(e).setOptions(opts),gaugeHumidity.maxValue=100,gaugeHumidity.setMinValue(-50),gaugeHumidity.animationSpeed=32,gaugeHumidity.set(30)}var Contador=0;function addData(e,t,a){void 0!==e&&null!=e&&(e.data.labels.push(t),e.data.datasets.forEach(e=>{e.data.push(a)}),e.update())}function removeData(e){void 0!==e&&null!=e&&(e.data.labels.shift(),e.data.datasets.forEach(e=>{e.data.shift()}),e.update())}var idCode,temperatura,hora,fecha,descripcion,titleAlert,descripcionAlert,MaxTemperatura=38,stepper=new Stepper(document.querySelector("#stpIngresar")),path=window.location.pathname,page=path.split("/").pop();switch(page){case"":document.querySelector("a[href='index.html']").style.backgroundColor="#323d4c";break;case"scanner.html":document.querySelector("a[href='attendance.html']").style.backgroundColor="#323d4c";break;case"student-info.html":document.querySelector("a[href='student.html']").style.backgroundColor="#323d4c";break;default:document.querySelector(`a[href='${page}']`).style.backgroundColor="#323d4c"}function nextStep(){let e=new Date;idCode=$("#txtCodigo").val(),temperatura=$("#txtTemperatura").val(),descripcion=Pushed?(hora=$("#txtHora").val(),fecha=$("#txtFecha").val(),$("#txtDescripcion").val()):(hora=e.toLocaleTimeString("en-US"),fecha=e.toLocaleDateString("en-US"),""),getStudent(idCode,validarForm)}function validarForm(t){if(t.exists()){let e=!0;e=validarCampo("#txtCodigo",e),e=validarCampo("#txtTemperatura",e),Pushed&&(e=validarCampo("#txtFecha",e),e=validarCampo("#txtHora",e)),e&&(t=(t=t.val())[Object.keys(t)[0]],obtenerImagen(idCode,"#cardImagen"),$("#regHora").text(hora),$("#regFecha").text(fecha),$("#txtIded").text(idCode),$("#txtIded").attr("href",`student-info.html?id=${idCode}`),$("#regTemp").text(temperatura+" ºC "),$("#txtCareer").text(t.carrera),$("#txtNombre").text(`${t.nombres} ${t.apellidos}`),37<parseInt(temperatura)?($("#regTemp").addClass("text-danger"),titleAlert=`⚠️: ${t.nombres} ${t.apellidos}`,descripcionAlert=`presenta fiebre de ${temperatura}ºC a las ${hora} 🤒🚨`):$("#regTemp").removeClass("text-danger"),stepper.next())}else document.querySelector("#txtCodigo").classList.add("is-invalid"),stepper.reset()}function validarCampo(e,t){let a=document.querySelector(e);return""===a.value?(a.classList.add("is-invalid"),!1):(a.classList.remove("is-invalid"),a.classList.add("is-valid"),!!t)}function ajustPerson(t){if(t.exists()){t=t.val();var a=Object.keys(t)[0];let e=t[a];e.fbcode=a,setPersonCard(e)}else alert("No se encontro informacion del estudiante")}function ajustAlert(e){let t=document.querySelector("#listAlertas");if(void 0!==t&&null!==t)if(e.exists())for(var a in t.innerHTML="",e=e.val()){a=e[a];a.temperatura>=MaxTemperatura&&setAlertCard(a)}else t.innerHTML=`
                <li class="d-flex justify-content-center">
                    <div class="align-items-center text-white bg-primary border-0">
                        <div class="d-flex">
                            <div class="toast-body">
                                No hay ninguna alerta
                            </div>
                        </div>
                    </div>
                </li>
            `}function setPersonCard(e){obtenerImagen(e.codigo,"#imgPerson"),$("#div-list").addClass("col-xl-8"),$("#div-person").removeClass("hide"),tableUser.columns.adjust().draw(),tableAttend.columns.adjust().draw(),$("#tdCarnet").text(e.codigo),$("#txt-Nombre").text(e.nombres),$("#tdApellido").text(e.apellidos),$("#tdCarrera").text(e.carrera),$("#tdDireccion").text(e.direccion),$("#link-person").attr("href",`student-info.html?id=${e.codigo}`),console.log(e.codigo),document.querySelector("#txtCodigo").value=e.codigo}function setAlertCard(e){let t=document.querySelector("ul#listAlertas"),a=document.createElement("li");a.classList.add("timeline-item"),a.innerHTML=`
            <strong>Temperatura: ${e.temperatura}º</strong>
            <span class="float-right text-muted text-sm">${e.fecha}</span>
            <p>La temperatura que se registro a las <span id="regHora" class="font-weight-bold">${e.hora}</span> 
            del estudiante es alta</p>
            
    `,t.appendChild(a)}let params=new URLSearchParams(location.search);var idPerson=params.get("id");function ajustAlertTable(e){if(e.exists())for(var t in e=e.val()){t=e[t];38<=t.temperatura&&setAlertTable(t)}else document.querySelector("#listAlertas").innerHTML=`
            <li class="d-flex justify-content-center">
                <div class="align-items-center text-white bg-primary border-0">
                    <div class="d-flex">
                        <div class="toast-body">
                            No hay ninguna alerta
                        </div>
                    </div>
                </div>
            </li>
        `}function setAlertTable(e){let t=document.querySelector("#listAlertas"),a=document.createElement("tr");a.innerHTML=`
        <td class="text-center">
            <img src="https://img.icons8.com/windows/24/000000/box-important--v4.png"/>
        </td>
        <td>
            La temperatura registrada es de ${e.temperatura}º, la cual, supera el rango normal establecido.
        </td>
        <td>
            ${e.fecha} ${e.hora}
        </td>
    `,t.appendChild(a),console.log(a)}null!=idPerson&&(console.log(idPerson),getStudent(idPerson,ajustPerson),getAttendees(idPerson,ajustAlertTable),$("#tabAlertas").click());var shadow=document.createElement("div");function toogleMenu(){let e=document.querySelector("aside#sidebar");document.querySelector("body").appendChild(shadow),e.classList.add("c-sidebar-show")}function toogleMinimizer(){let e=document.querySelector("h1#sbTitle");e.classList.contains("hide")?e.classList.remove("hide"):e.classList.add("hide")}function fillFrmAttend(e){document.querySelector("#txtHora").value=e.hora,document.querySelector("#txtFecha").value=e.fecha.split("/").reverse().join("-"),document.querySelector("#txtCodigo").value=e.codigo,document.querySelector("#txtDescripcion").value=e.descripcion,document.querySelector("#txtTemperatura").value=e.temperatura,document.querySelector("#idAsistencia").value=e.idFirebase,$("#regAsistencia").modal("show"),Pushed||document.querySelector("#btnMas").click()}function resetModal(){stepper.reset(),document.querySelector("#idAsistencia").value="",document.querySelector("#txtCodigo").classList.remove("is-valid"),document.querySelector("#txtTemperatura").classList.remove("is-valid"),document.querySelector("#txtFecha").classList.remove("is-valid"),document.querySelector("#txtHora").classList.remove("is-valid"),document.querySelector("form#frm-attend").reset()}shadow.className="c-sidebar-backdrop c-fade c-show",shadow.addEventListener("click",()=>{shadow.parentNode.removeChild(shadow),sidebar.classList.remove("c-sidebar-show")}),document.querySelector("aside#sidebar").addEventListener("click",e=>{console.log(e.target)}),document.getElementById("regAsistencia").addEventListener("hidden.bs.modal",resetModal);var Pushed=!1,btnMas=document.querySelector("#btnMas");function fillFrmStudent(e){document.querySelector("#txtNombres").value=e.nombres,document.querySelector("#txtApellidos").value=e.apellidos,document.querySelector("#txtCarrera").value=e.carrera,document.querySelector("#txtCarnet").value=e.codigo,document.querySelector("#txtCorreo").value=e.correo,document.querySelector("#txtDireccion").value=e.direccion,document.querySelector("#txtSexo").value=e.sexo,document.querySelector("#txtTelefono").value=e.telefono,document.querySelector("#idEstudiante").value=e.idFirebase,obtenerImagen(e.codigo,"#profileImage"),$("#record-student").modal("show")}function setProfileImage(e){document.querySelector("#profileImage").src=URL.createObjectURL(e.target.files[0])}function openNewAttend(e){document.body.classList.contains("modal-open")||document.querySelector("#fab").click(),document.querySelector("#txtCodigo").value=e,nextStep()}btnMas.addEventListener("click",function(){btnMas.innerText=Pushed?"Ver más":"Ver menos",Pushed=!Pushed}),document.getElementById("regAsistencia").addEventListener("hidden.bs.modal",()=>{document.querySelector("#idEstudiante").value=""});var isServing=!1;const divConsole=document.getElementById("console"),btnServer=document.getElementById("btnServer"),onlyServer=document.getElementById("only-server"),errorText='<span class="badge bg-danger">Error: </span><span style="color:red">';if(void 0!==divConsole&&null!=divConsole){const Ua=new PerfectScrollbar(divConsole)}void 0!==btnServer&&null!=btnServer&&btnServer.addEventListener("click",()=>{divConsole.innerHTML="Intentando conectarse <br>",navigator.serial?connectSerial():writeInConsole(errorText+"Web Serial API no soportada.</span>")});async function connectSerial(){try{const t=await navigator.serial.requestPort();await t.open({baudRate:9600});var e=new TextDecoderStream;t.readable.pipeTo(e.writable);const a=e.readable,r=a.getReader();for(setServing(!0);;){const{value:o,done:n}=await r.read();if(o&&(writeInConsole(o.toString()),fromArduino(o.toString())),n){console.log("[readLoop] DONE",n),r.releaseLock(),setServing(!1);break}}}catch(e){writeInConsole(errorText+e+"</span>"),setServing(!1)}}function writeInConsole(e){void 0!==divConsole&&null!=divConsole&&(divConsole.innerHTML+="<br>"+e,divConsole.scrollTop=divConsole.scrollHeight)}function toArduino(){var e=document.getElementById("txtArduino").value;document.getElementById("txtArduino").value="",document.sendform.txtArduino.focus(),dbSensor1.child("to-serial").set(e,e=>{e&&console.log("Error al escribir: "+e)})}function setServing(e){isServing=e,btnServer.innerText=isServing?"Conectado":"Conectar"}var tableUser=$("#table-user").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:[{targets:[0],visible:!1},{targets:[1],render:function(e){return`<img loading="lazy" style="border-radius:50%" src="https://res.cloudinary.com/js-media/image/upload/c_scale,e_auto_brightness,h_48,q_80,w_48/v1620739560/STC-UNI/Estudiantes/${e}.jpg" alt="${e}">`}},{targets:[10],render:e=>`<div class='wrapper text-center'>
                    <div class='btn-group'>
                        <button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>
                            <svg class="c-icon c-icon-x">
                                <use xlink:href="assets/svg-symbols.svg#edit"></use>
                            </svg>
                        </button>
                        <button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>
                            <svg class="c-icon c-icon-x">
                                <use xlink:href="assets/svg-symbols.svg#delete"></use>
                            </svg>
                        </button>
                        <input type="hidden" value="${e}">
                    </div>
                </div>`}]});$("#table-user tbody").on("click","tr",function(){var e=tableUser.row(this).data();void 0!==e&&(setPersonCard({fbcode:e[0],codigo:e[1],nombres:e[3],apellidos:e[4],carrera:e[5],sexo:e[6],direccion:e[7]}),getAttendees(e[1],ajustAlert))}),$("#table-user").on("click",".btnEditar",e=>{getStudentById(e.target.closest(".btn-group").querySelector("input").value,fillFrmStudent)}),$("#table-user").on("click",".btnBorrar",e=>{let t=e.target.closest(".btn-group").querySelector("input");Swal.fire({title:"¿Está seguro de eliminar al estudiante?",text:"¡Está operación no se puede revertir!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Borrar"}).then(e=>{e.value&&(db.ref().child(`estudiantes/${t.value}`).remove(),Swal.fire("¡Eliminado!","El estudiante ha sido eliminado.","success"))})});const clDefAttend=[{targets:[0],visible:!1},{targets:[1],render:e=>`
            <div class='wrapper text-center'>
                <img loading="lazy" style="border-radius:50%" src="https://res.cloudinary.com/js-media/image/upload/c_scale,e_auto_brightness,h_48,q_80,w_48/v1620739560/STC-UNI/Estudiantes/${e}.jpg" alt="${e}">
            </div>
        `},{targets:[2],render:e=>{return`
            <div class="d-flex flex-column">
                <div>${e.temperatura<MaxTemperatura?`<span class="badge bg-light text-dark">${e.temperatura}</span>`:`<span class="badge bg-danger">${e.temperatura}</span>`}</div>
                <span class="small text-muted">${e.codigo}</span>
            </div>`}},{targets:[3],render:e=>`
            <div class="d-flex flex-column">
                <div>${e.fecha}</div>
                <span class="small text-muted">${e.hora}</span>
            </div>
        `},{targets:[4],render:e=>`
            <div class='wrapper text-center'>
                <div class='btn-group'>
                    <button class='btnEditar btn btn-primary' data-toggle='tooltip' title='Editar'>
                        <svg class="c-icon c-icon-x">
                            <use xlink:href="assets/svg-symbols.svg#edit"></use>
                        </svg>
                    </button>
                    <button class='btnBorrar btn btn-danger' data-toggle='tooltip' title='Borrar'>
                        <svg class="c-icon c-icon-x">
                            <use xlink:href="assets/svg-symbols.svg#delete"></use>
                        </svg>
                    </button>
                    <input type="hidden" value="${e}">
                </div>
            </div>`}];var tableAttend=$("#table-attend").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:clDefAttend}),tablehight=$("#table-hight").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:clDefAttend}),tablePerson=$("#table-attend-personal").DataTable({responsive:!0,language:{url:"./assets/translate.json"},columnDefs:clDefAttend});function drawStudentTable(e){for(var t in tableUser.clear().draw(),e){var a=e[t];dataSet=[t,a.codigo,a.codigo,a.nombres,a.apellidos,a.carrera,a.sexo,a.direccion,a.telefono,a.correo,t],tableUser.rows.add([dataSet]).draw()}tableUser.columns.adjust().draw()}function drawAttendTable(e){for(var t in tablePerson.clear().draw(),tableAttend.clear().draw(),tablehight.clear().draw(),e){var a=e[t];dataSet=[t,a.codigo,{codigo:a.codigo,temperatura:a.temperatura},{fecha:a.fecha,hora:a.hora},t],tableAttend.rows.add([dataSet]).draw(),37<a.temperatura&&tablehight.rows.add([dataSet]).draw(),a.codigo===idPerson&&tablePerson.rows.add([dataSet]).draw()}tablePerson.columns.adjust().draw(),tableAttend.columns.adjust().draw(),tablehight.columns.adjust().draw()}$("#table-attend tbody").on("click","tr",function(){var e=tableAttend.row(this).data();void 0!==e&&(getStudent(e[1],ajustPerson),getAttendees(e[1],ajustAlert))}),$("#table-attend, #table-hight, #table-attend-personal").on("click",".btnEditar",e=>{getAttendById(e.target.closest(".btn-group").querySelector("input").value,fillFrmAttend)}),$("#table-attend, #table-hight, #table-attend-personal").on("click",".btnBorrar",e=>{let t=e.target.closest(".btn-group").querySelector("input");Swal.fire({title:"¿Está seguro de eliminar la asistencia?",text:"¡Está operación no se puede revertir!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Borrar"}).then(e=>{e.value&&(db.ref().child(`asistencias/${t.value}`).remove(),Swal.fire("¡Eliminado!","La Asistencia ha sido eliminado.","success"))})});